#!/bin/bash

declare B=$'\033[1m' X=$'\033[0m'
[[ ! -t 1 ]] && B= && X=

DIR="$HOME/.local/share/iam"
[[ -d "$DIR" ]] || mkdir -p "$DIR" &>/dev/null

declare -A modes
modes[muted]='🔇'
modes[live]='🔴'
modes[away]='🐟'
modes[working]='☕'
modes[chatting]='💬'
modes[ranting]='🤬'
modes[recording]='🎬'
modes[partying]='🎉'
modes[gaming]='🕹️ '

x_modes() {
  for i in "${!modes[@]}"; do
    echo "${modes[$i]} ${B}${i^}$X"
  done
}

x_live() {
  ps -ef |grep -v grep| grep obs &>/dev/null
  test $? && echo "${modes[live]}"
}

_basic() {
  local message="$*" buf
  [[ -z "$message" ]] && read -r message -p "Message: "
  buf="${modes[$CMD]} $CMD $message"
  t "$buf" 2>/dev/null
  echo "$CMD" > "$DIR/mode"
}

x_working() { _basic "$@"; }
x_chatting() { _basic "$@"; }
x_ranting() { x_speaking; _basic "$@"; }
x_partying() { x_speaking; _basic "$@"; }
x_recording() { x_speaking; _basic "$@"; }
x_gaming() { x_speaking; _basic "$@"; }

x_away() {
  local message="$*"
  [[ -z "$message" ]] && message="since $(date +%FT%T%z)"
  away="🐟 away $message"
  t "$away" 2>/dev/null
  echo "$CMD" > "$DIR/mode"
  pomo stop
  fishies
}

x_muted() { touch "$DIR/muted"; }
x_speaking() { rm "$DIR/muted"; }
x_mode() {
  local mode muted
  [[ -e "$DIR/mode" ]] || return 1
  mode="$(<"$DIR/mode")"
  [[ -e "$DIR/muted" ]] && muted=muted
  if [[ $1 = emoji ]]; then
    printf "%s" "${modes[$mode]}"
    [[ -n "$muted" ]] && echo " ${modes[$muted]}"
  else
    printf "%s" "$mode"
    [[ -n "$muted" ]] && echo " $muted"
  fi
}

#--------------------- completion and delegation --------------------

while IFS= read -r line; do
    [[ $line =~ ^declare\ -f\ x_ ]] || continue
    COMMANDS+=( "${line##declare -f x_}" )
done < <(declare -F)

if [[ -n $COMP_LINE ]]; then
    line=${COMP_LINE#* }
    for c in "${COMMANDS[@]}"; do
        [[ ${c:0:${#line}} == "${line,,}" ]] && echo "$c"
    done
    exit
fi

EXE="${0##*/}"
for c in "${COMMANDS[@]}"; do
    if [[ $c == "$EXE" ]]; then
        "x_$EXE" "$@"
        exit $?
    fi
done

CMD="$1"; shift
for c in "${COMMANDS[@]}"; do
    if [[ $c == "$CMD" ]]; then
        "x_$CMD" "$@"
        exit $?
    fi
done

